<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>浏览器的工作原理</title>
</head>

<body>

  <h1>浏览器的工作原理</h1>

  从 输入 一个URL 到 页面 加载完成 的 过程：

  <h3>1、浏览器 发起 DNS查询 请求</h3>

  我们 在 浏览器 的 地址栏 中 输入 一个 url 并 回车 之后 ，浏览器 会发起 DNS 查询请求，把 域名 转换为 真实 的 IP地址， <br>


  <h3>2、浏览器 跟 服务器 建立连接 : TCP握手机制 （甚至包括 TLS 握手 ）</h3>

  根据 IP地址 找到 提供网站内容 的 服务器，在 找到 服务器 之后，浏览器 会通过 TCP握手机制 跟 服务器 建立 连接， <br><br>

  现在 大部分 服务器 传输 都是 基于 HTTPS 协议 的, 那么会 多一步 TLS 握手, 建立 加密的隧道, 保证 数据传输 不被监听、篡改 <br><br>


  <h3>3、浏览器 发起请求(http/https) 来获取 服务器响应</h3>

  在 建立了 浏览器 和 服务器 之间 的 连接 之后，浏览器 会 发起 http 或者 https 请求 来获取 服务器 响应， <br><br>

  对于 网站 来说，响应 就是 服务器 返回 的 HTML网页代码，这里 在 接收 服务器响应 的 时候，有一个 slow start 的 机制， <br><br>

  受制于 TCP 连接 的 限制，浏览器 会 先收到 前 14KB 的 数据，后续 才会 慢慢地 增加 传输速度，下载其他文件。 <br><br>

  所以 对于 服务器 来说，能够在 这 14KB 的 数据 里 完整 的 展现 网站 就变得 很重要了。 <br><br> <br><br>


  浏览器 在 收到 HTML代码 之后，浏览器 开始 渲染 网页，这里 一共 有 五部分 ，这 五部分 统称为 关键渲染路径： <br><br>


  <h3>4、关键渲染路径</h3>

  <h4>（1）解析 HTML 并 构建 DOM树 </h4>
  DOM树 是 HTML文档 在浏览器中的对象, 表示 可以用 javascript 来 操作 它。 <br><br>

  浏览器 在 解析 HTML 的 时候 是 顺序执行的，并且 只有 一个 主线程 负责 解析， <br><br>

  如果 遇到 script标签（不包含 async、defer属性 的 script标签），那么 浏览器 会下载 javascript文件 并 执行里面的代码， <br><br>

  这个时候 主线程 会 暂停 解析 HTML ，只有 JS 代码 执行完成之后 ，才会 继续 解析 HTML的 。 <br><br>


  对于 图片 和 CSS文件，或者是 设置了 defer 或者是 async 的 script 标签，那么 它 不会影响主线程，而是会异步的下载。 <br><br>

  <h5>预扫描 线程 Pre Scanner</h5>

  另外 浏览器 有一个 预扫描线程 Pre Scanner ，它会 扫描 HTML 代码，提前把 CSS文件、字体 以及 JS文件 下载下来，这里 的 下载 是 异步的，不会影响主线程。 <br><br>


  <h4>(2) 构建 CSSOM 树</h4>

  第二步 是 构建 CSS Object Model 树 ， CSS Object Model 是 CSS 在 浏览器 中 的 对象， 表示 也是 树状结构。 <br><br>


  <h4>(3) 合并 DOM 和 CSSOM </h4>
  第三步 ，浏览器 会从 DOM 的 根节点 开始， 合并 CSS Object Model 中 的 样式 到 DOM中 的 每个节点，形成一颗渲染树。


  <h4>(4) 布局 </h4>
  第四步，生成 渲染树 之后，浏览器 会根据 样式 ，计算 每个可见节点，也就是 没有 设置 display 为 none 的 节点，它们 的 宽高 和 位置 等，对 所有的节点 进行 布局规划。 <br><br>

  对于 图片 这类节点，如果 没有 指定 宽高，浏览器 会 先忽略 它 的 大小，等 图片 加载完成 之后， <br><br>

  浏览器会根据 图片 的 宽高 和 位置， 再次 计算 受影响 的 节点 的 大小 和 位置，这个过程 叫 回流 （reflow） <br><br>


  <h4>(5) 绘制</h4>
  第五步，在 第一次 布局 完成 之后 ，浏览器 会 真正的 把 节点 和 节点的样式，例如： 背景、阴影、边框 等 绘制到 屏幕上， <br><br>

  这个，要求 过程 必须要 十分的快速，否则 会影响 动画 和 交互 的 性能。 <br><br>

  如果之前布局 发生了回流，也就是 加载了 像图片 这样的节点之后，浏览器 还会发生 重绘，把 变化 的 布局 重新 绘制到 屏幕上。 <br><br> <br><br>


  在 绘制 期间，也可能会有 组合 发生。因为在渲染节点时 可能会产生新的图层， <br><br>

  例如：video 标签 或者 设置了 opacity ，will-change , transform 等 属性 的 节点， <br><br>

  浏览器 还需要 把 这些图层 组合起来，按 正确的 堆叠顺序 渲染，同样 的 回流 和 重绘 操作 也会 引发 重新组合 操作。 <br><br>

  在上面 五步 完成之后，设置了 defer 或者是 async 的 JavaScript 文件 开始 加载 并 执行完成 之后， <br><br>

  整个网页 就 下载完成了，并且 可以 和 用户 进行交互了，这个就是浏览器的工作原理。 <br><br>



</body>

</html>